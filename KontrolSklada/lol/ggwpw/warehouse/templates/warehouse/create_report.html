{% extends 'warehouse/base.html' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç - –°–∫–ª–∞–¥—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-file-plus"></i> –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞</h4>
            </div>
            <div class="card-body">
                <form method="post" id="reportForm">
                    {% csrf_token %}
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ 10.10.2025">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="report_type" class="form-label">–¢–∏–ø –æ—Ç—á–µ—Ç–∞ *</label>
                            <select class="form-select" id="report_type" name="report_type" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                                {% for value, label in report_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="description" name="description" rows="2" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç—á–µ—Ç–µ"></textarea>
                    </div>
                    
                    <!-- –ü–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
                    <div class="row mb-3" id="dateRange">
                        <div class="col-md-6">
                            <label for="date_from" class="form-label">–î–∞—Ç–∞ —Å</label>
                            <input type="date" class="form-control" id="date_from" name="date_from">
                        </div>
                        <div class="col-md-6">
                            <label for="date_to" class="form-label">–î–∞—Ç–∞ –ø–æ</label>
                            <input type="date" class="form-control" id="date_to" name="date_to">
                        </div>
                    </div>
                    
                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º -->
                    <div class="mb-3" id="sectorsFilter">
                        <label class="form-label">–°–µ–∫—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–∞</label>
                        <div class="row">
                            {% for sector in sectors %}
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           value="{{ sector.id }}" id="sector_{{ sector.id }}" name="sectors">
                                    <label class="form-check-label" for="sector_{{ sector.id }}">
                                        {{ sector.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ç–æ—Ä–æ–≤</small>
                    </div>
                    
                    <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –ü–í–ó -->
                    <div class="mb-3" id="pvzFilter" style="display: none;">
                        <label class="form-label">–ü—É–Ω–∫—Ç—ã –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–æ–≤</label>
                        <div class="row">
                            {% for pvz in pickup_points %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           value="{{ pvz.id }}" id="pvz_{{ pvz.id }}" name="pickup_points">
                                    <label class="form-check-label" for="pvz_{{ pvz.id }}">
                                        {{ pvz.name }} <small class="text-muted">({{ pvz.address }})</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –ü–í–ó</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'reports_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-file-plus"></i> –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–∞—Ö –æ—Ç—á–µ—Ç–æ–≤ -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>üìã –û—Ç—á–µ—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º</h6>
                        <p class="small text-muted mb-3">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º, 
                            —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º.
                        </p>
                        
                        <h6>üîÑ –û—Ç—á–µ—Ç –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é —Ç–æ–≤–∞—Ä–æ–≤</h6>
                        <p class="small text-muted mb-3">
                            –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Å–ø–∏—Å–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ 
                            –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>üìÆ –û—Ç—á–µ—Ç –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º –ü–í–ó</h6>
                        <p class="small text-muted mb-3">
                            –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø—É–Ω–∫—Ç–æ–≤ –≤—ã–¥–∞—á–∏: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º, 
                            —Å–∞–º—ã–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã.
                        </p>
                        
                        <h6>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</h6>
                        <p class="small text-muted mb-3">
                            –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–∫–ª–∞–¥—É, —Ç—Ä–µ–Ω–¥—ã, 
                            —Ç–æ–ø —Ç–æ–≤–∞—Ä—ã –∏ —Å–µ–∫—Ç–æ—Ä—ã.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('report_type');
    const dateRange = document.getElementById('dateRange');
    const sectorsFilter = document.getElementById('sectorsFilter');
    const pvzFilter = document.getElementById('pvzFilter');
    
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date().toISOString().split('T')[0];
    const monthAgo = new Date();
    monthAgo.setMonth(monthAgo.getMonth() - 1);
    const monthAgoStr = monthAgo.toISOString().split('T')[0];
    
    document.getElementById('date_to').value = today;
    document.getElementById('date_from').value = monthAgoStr;
    
    function updateFormFields() {
        const selectedType = reportTypeSelect.value;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
        switch(selectedType) {
            case 'inventory':
                dateRange.style.display = 'none';
                sectorsFilter.style.display = 'block';
                pvzFilter.style.display = 'none';
                break;
            case 'movements':
                dateRange.style.display = 'flex';
                sectorsFilter.style.display = 'block';
                pvzFilter.style.display = 'none';
                break;
            case 'requests':
                dateRange.style.display = 'flex';
                sectorsFilter.style.display = 'none';
                pvzFilter.style.display = 'block';
                break;
            case 'statistics':
                dateRange.style.display = 'flex';
                sectorsFilter.style.display = 'block';
                pvzFilter.style.display = 'block';
                break;
            default:
                dateRange.style.display = 'none';
                sectorsFilter.style.display = 'none';
                pvzFilter.style.display = 'none';
        }
    }
    
    reportTypeSelect.addEventListener('change', updateFormFields);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
    reportTypeSelect.addEventListener('change', function() {
        const titleInput = document.getElementById('title');
        if (!titleInput.value) {
            const typeText = this.options[this.selectedIndex].text;
            const today = new Date().toLocaleDateString('ru-RU');
            titleInput.value = `${typeText} –Ω–∞ ${today}`;
        }
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    document.getElementById('reportForm').addEventListener('submit', function(e) {
        const reportType = reportTypeSelect.value;
        
        if (!reportType) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞');
            return;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...';
        submitBtn.disabled = true;
        
        // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –≤–µ—Ä–Ω–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 30000);
    });
});
</script>
{% endblock %}